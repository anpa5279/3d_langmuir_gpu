#!/bin/bash

jobn=npzd-distr-cpu
rm -rf $jobn
mkdir $jobn

cp langmuir_turb.jl ouputs/$jobn/
cp stokes.jl ouputs/$jobn/

cd ouputs/$jobn/
touch Project.toml

cat > EXEC_STEP << EXEC
#!/bin/sh

#PBS -A UCUB0166 
#PBS -N $jobn
#PBS -q main 
#PBS -j oe
#PBS -l job_priority=economy
#PBS -l walltime=06:30:00
#PBS -l select=1:ncpus=64:mpiprocs=4

# Use moar processes for precompilation to speed things up
export JULIA_NUM_PRECOMPILE_TASKS=64
export JULIA_NUM_THREADS=64

# Load critical modules
module --force purge
module load ncarenv/23.09 nvhpc/24.7 cray-mpich/8.1.29

module list

# Utter mystical incantations to perform various miracles
export PALS_TRANSFER=false

julia --project -e 'using Pkg; Pkg.instantiate()'
# 2. Update packages to the environment that we need to use. not always necessary
julia --project -e 'using Pkg; Pkg.add("MPI"); Pkg.add("MPIPreferences");; Pkg.add("Oceananigans"); Pkg.add("Printf"); Pkg.add("Statistics"); Pkg.add("Random"); Pkg.add("DifferentialEquations")'
julia --project -e 'using MPIPreferences; MPIPreferences.use_system_binary(vendor="cray")'
julia --project -e 'using MPI'
# Only need to run if you want to reset or update things (did you update the amount of  nodes and processors?)
# Finally, let's run this thing

mpiexec -n 4 julia --project langmuir_turb.jl
EXEC

qsub < EXEC_STEP
