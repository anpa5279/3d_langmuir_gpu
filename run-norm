#!/bin/bash
nodes=1
gpus=2
cpus=64
ntasks=$((nodes*gpus))
threads_per_task=$(( cpus / ntasks ))
jobn=run13c-WENO5
output_dir=outputs/legacy-code-comparison/ppt-comparison/
project_dir=/glade/work/apauls/.julia/environments/v1.10/
file_name=langmuir_turb.jl
rm -rf $output_dir$jobn
mkdir $output_dir$jobn

cp $file_name $output_dir$jobn/
cp stokes.jl $output_dir$jobn/

cd $output_dir$jobn/

cat > EXEC_STEP << EXEC
#!/bin/sh

#PBS -A UCUB0166
#PBS -N $jobn
#PBS -q develop
#PBS -j oe
###PBS -l job_priority=economy
#PBS -l walltime=6:00:00
#PBS -l select=$nodes:ncpus=$cpus:mem=20gb:ngpus=$gpus:gpu_type=cc80

export JULIA_NUM_PRECOMPILE_TASKS=$cpus
export JULIA_NUM_THREADS=$cpus

module --force purge
module load ncarenv nvhpc cuda cray-mpich

module list

export MPICH_GPU_SUPPORT_ENABLED=1
export JULIA_MPI_HAS_CUDA=true
export PALS_TRANSFER=false
export JULIA_CUDA_MEMORY_POOL=none

cat > launch.sh << EoF_s
#! /bin/bash

export MPICH_GPU_SUPPORT_ENABLED=1
export LOCAL_RANK=\${PMI_LOCAL_RANK}
export GLOBAL_RANK=\${PMI_RANK}
export CUDA_VISIBLE_DEVICES=\$(expr \${LOCAL_RANK} % \$gpus)

echo "Global Rank \${GLOBAL_RANK} / Local Rank \${LOCAL_RANK} / CUDA_VISIBLE_DEVICES=\${CUDA_VISIBLE_DEVICES} / \$(hostname)"

exec \$*
EoF_s

chmod +x launch.sh

##julia --project=$project_dir -e 'import Pkg'
##julia --project=$project_dir -e 'using Pkg; Pkg.instantiate()'
##julia --project=$project_dir -e 'using Pkg; Pkg.resolve()'
julia --project=$project_dir -e 'using Pkg; Pkg.add(Pkg.PackageSpec(;name="Oceananigans", version="0.100.7"))'
##julia --project=$project_dir -e 'using Pkg; Pkg.add("Oceananigans"); Pkg.add("MPI"); Pkg.add("MPIPreferences"); Pkg.add("CUDA"); Pkg.add("Statistics"); Pkg.add("Printf"); Pkg.add("Random")'
julia --project=$project_dir -e 'using MPIPreferences; MPIPreferences.use_system_binary(vendor="cray")'
julia --project=$project_dir -e 'using MPI; using CUDA; CUDA.precompile_runtime()'

mpiexec -n $ntasks -ppn $gpus ./launch.sh julia --project=$project_dir $file_name
EXEC

qsub < EXEC_STEP